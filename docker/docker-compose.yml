services:
  adminer:
    image: adminer
    restart: unless-stopped
    # Bind ao loopback para evitar exposição pública em dev
    ports:
      - "127.0.0.1:8080:8080"

  db:
    image: postgres:15
    restart: unless-stopped
    env_file:
      - ../.env
    environment:
      TZ: ${POSTGRES_TZ:-UTC}
      POSTGRES_USER: dba
      POSTGRES_PASSWORD: dba
      POSTGRES_DB: BotDB
    volumes:
      - db_data:/var/lib/postgresql/data
    # Em produção, NÃO exponha 5432. Em dev, use 127.0.0.1 se necessário.
    ports:
      - "127.0.0.1:${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dba -d BotDB"]
      interval: 10s
      timeout: 5s
      retries: 5

  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    env_file:
      - ../.env
    environment:
      PYTHONPATH: ${PYTHONPATH:-/app/src}
      AUTO_MIGRATE: ${AUTO_MIGRATE:-true}
      DATABASE_URL: postgresql+psycopg2://dba:dba@db:5432/BotDB
      POSTGRES_USER: dba
      POSTGRES_PASSWORD: dba
      POSTGRES_DB: BotDB
      POSTGRES_HOST: db
      POSTGRES_PORT: 5432
    depends_on:
      - db
    # Publica a API na porta 3333 do host (apenas no loopback em dev)
    ports:
      - "127.0.0.1:3333:3333"
    volumes:
      - ../:/app
    restart: unless-stopped
    healthcheck:
      test:
        ["CMD-SHELL", "curl -fsS http://localhost:3333/api/v1/health || exit 1"]
      interval: 10s
      timeout: 2s
      retries: 3

  waha:
    image: devlikeapro/waha:latest
    container_name: wpp_bot_waha
    restart: always
    # Bind ao loopback para limitar acesso (evita exposição pública)
    ports:
      - "127.0.0.1:3000:3000"
    # opcional: se preferir não publicar a porta no host, use expose:
    # expose:
    #   - "3000"

volumes:
  db_data:
